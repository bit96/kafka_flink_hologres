# 数据库设计文档

## 1. 概述

本文档定义了 Kafka-Flink-Hologres 自动化工具所需的 Hologres 数据库表结构。主要包括两个核心表：
1. **Kafka 配置表**：存储 Kafka 连接信息和 Topic 配置
2. **Flink SQL 记录表**：存储生成的 Flink SQL 代码和元数据

## 2. Kafka 配置表

### 2.1 表名
`kafka_topic_config`

### 2.2 表结构

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 自增主键 |
| topic_name | TEXT | NOT NULL, UNIQUE | Kafka Topic 名称 |
| kafka_brokers | TEXT | NOT NULL | Kafka Broker 地址列表，逗号分隔 |
| data_format | TEXT | NOT NULL DEFAULT 'json' | 数据格式（json, avro, protobuf） |
| description | TEXT | NULL | Topic 描述 |
| is_active | BOOLEAN | NOT NULL DEFAULT true | 是否启用 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新时间 |

### 2.3 DDL 语句

```sql
-- 创建 Kafka 配置表
CREATE TABLE IF NOT EXISTS kafka_topic_config (
    id BIGSERIAL PRIMARY KEY,
    topic_name TEXT NOT NULL UNIQUE,
    kafka_brokers TEXT NOT NULL,
    data_format TEXT NOT NULL DEFAULT 'json',
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_kafka_topic_config_topic_name ON kafka_topic_config(topic_name);
CREATE INDEX idx_kafka_topic_config_is_active ON kafka_topic_config(is_active);

-- 添加表注释
COMMENT ON TABLE kafka_topic_config IS 'Kafka Topic 配置信息表';
COMMENT ON COLUMN kafka_topic_config.id IS '自增主键';
COMMENT ON COLUMN kafka_topic_config.topic_name IS 'Kafka Topic 名称';
COMMENT ON COLUMN kafka_topic_config.kafka_brokers IS 'Kafka Broker 地址列表，格式：host1:port1,host2:port2';
COMMENT ON COLUMN kafka_topic_config.data_format IS '数据格式：json, avro, protobuf';
COMMENT ON COLUMN kafka_topic_config.description IS 'Topic 描述信息';
COMMENT ON COLUMN kafka_topic_config.is_active IS '是否启用该配置';
COMMENT ON COLUMN kafka_topic_config.created_at IS '创建时间';
COMMENT ON COLUMN kafka_topic_config.updated_at IS '更新时间';
```

### 2.4 示例数据

```sql
-- 插入示例配置（无认证）
INSERT INTO kafka_topic_config (
    topic_name,
    kafka_brokers,
    data_format,
    description
) VALUES (
    'user_events',
    'kafka-broker1:9092,kafka-broker2:9092,kafka-broker3:9092',
    'json',
    '用户行为事件流'
);

```

## 3. Flink SQL 记录表

### 3.1 表名
`flink_sql_record`

### 3.2 表结构

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 自增主键 |
| topic_id | BIGINT | NOT NULL | 关联的 Kafka Topic 配置 ID |
| topic_name | TEXT | NOT NULL | Kafka Topic 名称（冗余字段，便于查询） |
| sink_table_name | TEXT | NOT NULL | Hologres Sink 表名 |
| source_ddl | TEXT | NOT NULL | Flink Source 表 DDL |
| sink_ddl | TEXT | NOT NULL | Flink Sink 表 DDL |
| insert_sql | TEXT | NOT NULL | INSERT INTO 语句 |
| full_sql | TEXT | NOT NULL | 完整的 Flink SQL（包含所有语句） |
| field_mapping | JSONB | NULL | 字段映射关系（JSON 格式） |
| inferred_schema | JSONB | NULL | 推断的数据结构（JSON 格式） |
| sample_count | INTEGER | NOT NULL DEFAULT 10 | 采样数据条数 |
| status | TEXT | NOT NULL DEFAULT 'generated' | 状态：generated, deployed, failed, deprecated |
| error_message | TEXT | NULL | 错误信息（如果有） |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| deployed_at | TIMESTAMPTZ | NULL | 部署时间 |
| deprecated_at | TIMESTAMPTZ | NULL | 废弃时间 |

### 3.3 DDL 语句

```sql
-- 创建 Flink SQL 记录表
CREATE TABLE IF NOT EXISTS flink_sql_record (
    id BIGSERIAL PRIMARY KEY,
    topic_id BIGINT NOT NULL,
    topic_name TEXT NOT NULL,
    sink_table_name TEXT NOT NULL,
    source_ddl TEXT NOT NULL,
    sink_ddl TEXT NOT NULL,
    insert_sql TEXT NOT NULL,
    full_sql TEXT NOT NULL,
    field_mapping JSONB,
    inferred_schema JSONB,
    sample_count INTEGER NOT NULL DEFAULT 10,
    status TEXT NOT NULL DEFAULT 'generated',
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deployed_at TIMESTAMPTZ,
    deprecated_at TIMESTAMPTZ
);

-- 创建索引
CREATE INDEX idx_flink_sql_record_topic_id ON flink_sql_record(topic_id);
CREATE INDEX idx_flink_sql_record_topic_name ON flink_sql_record(topic_name);
CREATE INDEX idx_flink_sql_record_sink_table ON flink_sql_record(sink_table_name);
CREATE INDEX idx_flink_sql_record_status ON flink_sql_record(status);
CREATE INDEX idx_flink_sql_record_created_at ON flink_sql_record(created_at DESC);

-- 添加表注释
COMMENT ON TABLE flink_sql_record IS 'Flink SQL 生成记录表';
COMMENT ON COLUMN flink_sql_record.id IS '自增主键';
COMMENT ON COLUMN flink_sql_record.topic_id IS '关联的 Kafka Topic 配置 ID';
COMMENT ON COLUMN flink_sql_record.topic_name IS 'Kafka Topic 名称';
COMMENT ON COLUMN flink_sql_record.sink_table_name IS 'Hologres Sink 表名';
COMMENT ON COLUMN flink_sql_record.source_ddl IS 'Flink Source 表 DDL 语句';
COMMENT ON COLUMN flink_sql_record.sink_ddl IS 'Flink Sink 表 DDL 语句';
COMMENT ON COLUMN flink_sql_record.insert_sql IS 'INSERT INTO 语句';
COMMENT ON COLUMN flink_sql_record.full_sql IS '完整的 Flink SQL 脚本';
COMMENT ON COLUMN flink_sql_record.field_mapping IS '字段映射关系（JSON 格式）';
COMMENT ON COLUMN flink_sql_record.inferred_schema IS '推断的数据结构（JSON 格式）';
COMMENT ON COLUMN flink_sql_record.sample_count IS '采样数据条数';
COMMENT ON COLUMN flink_sql_record.status IS '状态：generated-已生成, deployed-已部署, failed-失败, deprecated-已废弃';
COMMENT ON COLUMN flink_sql_record.error_message IS '错误信息';
COMMENT ON COLUMN flink_sql_record.created_at IS '创建时间';
COMMENT ON COLUMN flink_sql_record.deployed_at IS '部署时间';
COMMENT ON COLUMN flink_sql_record.deprecated_at IS '废弃时间';
```

### 3.4 字段说明

#### 3.4.1 field_mapping 字段格式
存储字段映射关系，JSON 格式示例：
```json
{
  "user_id": {
    "source_type": "BIGINT",
    "sink_type": "BIGINT",
    "nullable": true
  },
  "user_name": {
    "source_type": "STRING",
    "sink_type": "TEXT",
    "nullable": true
  },
  "created_time": {
    "source_type": "TIMESTAMP(3)",
    "sink_type": "TIMESTAMPTZ",
    "nullable": true
  }
}
```

#### 3.4.2 inferred_schema 字段格式
存储推断的数据结构，JSON 格式示例：
```json
{
  "fields": [
    {
      "name": "user_id",
      "type": "BIGINT",
      "nullable": true,
      "sample_values": [1001, 1002, 1003]
    },
    {
      "name": "user_name",
      "type": "TEXT",
      "nullable": true,
      "sample_values": ["Alice", "Bob", "Charlie"]
    }
  ],
  "sample_data_count": 10,
  "inference_time": "2025-11-19T10:30:00Z"
}
```

#### 3.4.3 status 字段取值
- `generated`：已生成，尚未部署
- `deployed`：已部署到 Flink 集群
- `failed`：部署或执行失败
- `deprecated`：已废弃，不再使用

## 4. 初始化脚本

完整的数据库初始化脚本将保存在项目的 `scripts/init_database.sql` 文件中。
